(()=>{if(console.log("content script running"),!document.getElementById("floating-sidebar-root")){const e=document.createElement("div");e.id="floating-sidebar-root",document.body.appendChild(e)}chrome.runtime.onMessage.addListener(((n,o,l)=>{if(console.log("Message received in content script:",n),"extract_content"===n.action)l({content:function(){const e=document.querySelectorAll("article p");let t="";return e.forEach((e=>{t+=e.innerText+"\n"})),console.log("Extracted page content:",t),t}()});else if("start_highlight_mode"===n.action){const{index:o}=n;!function(n){e=!0,t=n,document.addEventListener("mouseup",i),console.log("Highlight mode activated.")}(o),l({status:"Highlight mode started"})}}));let e=!1,t=null;function n(e){chrome.storage.local.get({highlights:[]},(t=>{const n=t.highlights.filter((t=>t.xpath!==e));chrome.storage.local.set({highlights:n})}))}function o(){console.log("Reapply highlighting!!"),chrome.storage.local.get({highlights:[]},(e=>{e.highlights.forEach((({text:e,questionIndex:t,xpath:o})=>{const i=function(e){return(new XPathEvaluator).evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}(o);i&&function(e,t,o,i){const l=e.innerHTML,r=`<span style="background: lightblue; border-radius: 3px; padding: 0 4px; margin-right: 4px;">${t}</span><span style="color: #ffffff; background-color: #0078D7; border-radius: 3px; padding: 0 6px; margin-left: 6px; font-size: 0.85em; font-weight: bold; cursor: pointer;" data-xpath="${i}"> [Q${o+1}]</span>`;e.innerHTML=l.replace(t,r);const d=e.querySelector(`[data-xpath="${i}"]`);d&&d.addEventListener("click",(()=>{confirm("Do you want to delete this highlight?")&&(n(i),e.innerHTML=l.replace(r,t))}))}(i,e,t,o)}))}))}function i(){if(!e)return;const o=window.getSelection();if(o&&o.toString().trim()){const l=o.getRangeAt(0),r=o.toString(),d=function(e){if(!e)return null;let t=e.nodeType===Node.TEXT_NODE?e.parentNode:e;const n=[];for(;t&&t.nodeType===Node.ELEMENT_NODE;){let e=0,o=t.previousSibling;for(;o;)o.nodeType===Node.ELEMENT_NODE&&o.nodeName===t.nodeName&&e++,o=o.previousSibling;const i=t.nodeName.toLowerCase(),l=e>0?`[${e+1}]`:"";n.unshift(`${i}${l}`),t=t.parentNode}return n.length?`/${n.join("/")}`:null}(l.commonAncestorContainer),c=l.cloneContents(),a=document.createDocumentFragment();c.childNodes.forEach((e=>{if(e.nodeType===Node.TEXT_NODE){const o=document.createElement("span");o.style.background="lightblue",o.style.borderRadius="3px",o.style.padding="0 4px",o.style.marginRight="4px",o.textContent=e.textContent;const i=document.createElement("span");i.textContent=` [Q${t+1}]`,i.style.color="#ffffff",i.style.backgroundColor="#0078D7",i.style.borderRadius="3px",i.style.padding="0 6px",i.style.marginLeft="6px",i.style.fontSize="0.85em",i.style.fontWeight="bold",i.style.cursor="pointer",i.addEventListener("click",(()=>{if(confirm("Do you want to delete this highlight?")){const e=o.parentNode,t=o.textContent;e.replaceChild(document.createTextNode(t),o),e.removeChild(i),n(d)}})),a.appendChild(o),a.appendChild(i)}else if(e.nodeType===Node.ELEMENT_NODE){const t=e.cloneNode(!0);highlightElementContents(t),a.appendChild(t)}})),l.deleteContents(),l.insertNode(a),chrome.runtime.sendMessage({action:"text_highlighted",text:r,index:t}),function(e,t,n){chrome.storage.local.get({highlights:[]},(o=>{const i=o.highlights;i.push({text:e,questionIndex:t,xpath:n}),chrome.storage.local.set({highlights:i})}))}(r,t,d),e=!1,t=null,document.removeEventListener("mouseup",i),console.log("Highlight mode deactivated.")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o()})();